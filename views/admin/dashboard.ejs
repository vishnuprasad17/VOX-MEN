<%- include('../includes/admin/adminHead.ejs') %>
    <link rel="stylesheet" href="/css/admin/heading.css ">
    <link rel="stylesheet" href="/css/admin/navBar.css ">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
    </head>
    <style>
        .categoryCard {
            min-height: 29.49rem;
        }

        .salesReportCard {
            min-height: 22.55rem;
        }
    </style>

    <body>
        <%- include('../includes/admin/sidebar.ejs') %>
            <main style="margin-top: 108px;">
                <div class="container mt-5">
                    <h1 class="header text-white mb-4">DASHBOARD</h1>
                    <div class=" container-fluid text-center">
                        <div class="row">
                            <div class="col-4  ">
                                <div class="card border-0 mb-5 mt-2 p-3  "
                                    style="box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;">
                                    <span class="h1"><i class="bi bi-people-fill" style="color: #000000;"></i></span>
                                    <span><span>Customers: </span> <span>
                                            <%=userCount?userCount:0 %>
                                        </span> </span>
                                </div>
                            </div>
                            <div class="col-4 ">
                                <div class="card border-0  mb-4 mt-2 p-3 "
                                    style="box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;">
                                    <span class="h1"><i class="bi bi-bank2" style="color: rgb(0, 0, 0);"></i></i></span>Revenue:
                                    ₹<%=totalSalesProfit?totalSalesProfit:0 %>
                                </div>
                            </div>
                            <div class="col-4 ">
                                <div class="card border-0 mb-4 mt-2 p-3 "
                                    style="box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;">
                                    <span class="h1"><i class="bi bi-graph-up-arrow"
                                            style="color: rgb(0, 0, 0);"></i></span>Sales: <%=orderCount?orderCount:0 %>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="monthlySales  col-12 col-lg-6">
                            <div class="p-3 card">
                                <span class="h4 text-center">Total Sales
                                </span>
                                <!-- <span class="h4 text-center">Total Sales of <%=salesYear %> - ₹ <%= totalSales %>
                                </span> -->
                                <span id="displayValue" hidden>
                                    <%=displayValue %>
                                </span>
                                <span id="xDisplayValue" hidden>
                                    <%=xDisplayValue %>
                                </span>
                                <div class="filerByYear mt-2">
                                    <form action="" method="get">
                                        <div class="row mb-3">
                                            <div class="col-9">
                                                <div class="d-flex">
                                                    <span>Year: </span> <select name="year" id=""
                                                        class="form-control me-2 ms-1">
                                                        <% displayYears.forEach((year)=>{ %>
                                                            <% if(salesYear==year) {%>
                                                                <option value="<%=year%>" selected>
                                                                    <%=year%>
                                                                </option>
                                                                <% } else{%>
                                                                    <option value="<%=year%>">
                                                                        <%=year%>
                                                                    </option>
                                                                    <% } %>

                                                                        <% }) %>

                                                    </select>
                                                </div>
                                                <div class="d-flex">
                                                    <span>Month: </span> <select name="month" id="monthofSale"
                                                        class="form-control me-2 mt-2 ms-1">

                                                        <option value="">---Choose---</option>
                                                        <option value="01">January</option>
                                                        <option value="02">February</option>
                                                        <option value="03">March</option>
                                                        <option value="04">April</option>
                                                        <option value="05">May</option>
                                                        <option value="06">June</option>
                                                        <option value="07">July</option>
                                                        <option value="08">August</option>
                                                        <option value="09">September</option>
                                                        <option value="10">October</option>
                                                        <option value="11">November</option>
                                                        <option value="12">December</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-3 text-center">
                                                <div class="mb-2">
                                                    <button class="btn btn-dark" type="submit">Submit</button>
                                                </div>
                                                <div>
                                                    <a href="/admin" class="btn btn-danger">Reset</a>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <span id="salesData" hidden>
                                    <%=sales %>
                                </span>
                                <span id="monthData" hidden>
                                    <%=months %>
                                </span>
                                <span id="salesYear" hidden>
                                    <%= salesYear %>
                                </span>

                                <!-- chart div -->
                                <div id="chart">
                                </div>
                            </div>
                        </div>

                        <div class=" col-lg-6 col-12 mt-5 mt-lg-0">
                            <div class="p-3 card ">
                                <h4 class="text-center">Category Sales</h4>
                                <div class="categoryCard">
                                    <div id="catChart" class="mt-5">
                                        <span id="categorySales" hidden>
                                            <%=categorySales %>
                                        </span>
                                        <span id="allCategories" hidden>
                                            <%=category %>
                                        </span>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-5 mb-5">
                        <div class="col-12 col-lg-6">
                            <div class="p-3 card ">
                                <h4 class="text-center">Payment Method usage</h4>
                                <div class="paymentCard mt-5">
                                    <div id="paymentChart">
                                        <span id="paymentMethods" hidden>
                                            <%=paymentMethods %>
                                        </span>
                                        <span id="paymentCount" hidden>
                                            <%=paymentCount %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-6 mt-5 mt-lg-0">
                            <div class="p-3 card salesReportCard ">
                                <h4 class="text-center">Sales Report</h4>
                                <div class="mt-3">
                                    <form action="" method="get">
                                        <label for="sDate" class="form-label">Starting Date: </label>
                                        <input type="date" name="sDate" id="sDate" class="form-control mb-3"
                                            max="<%=new Date().toISOString().split('T')[0]%>"
                                            onchange="updateToDateMin()" required>
                                        <label for="eDate" class="form-label">Ending Date: </label>
                                        <input type="date" name="eDate" id="eDate" class="form-control mb-3"
                                            max="<%=new Date().toISOString().split('T')[0]%>" required>

                                        <div class="text-center mt-3">
                                            <button class="btn btn-dark w-50" type="submit">Get</button>
                                        </div>
                                    </form>
                                    <div class="text-center mt-2">
                                        <a href="/admin"><button class="btn btn-secondary  w-50">Reset</button></a>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="salesReportData mb-5">
                        <div>
                            <h3>Sales Report Table</h3>
                        </div>
                        <div class="mt-3 mb-3">
                            <button class="btn btn-danger" onclick="printTable()">Export Pdf <i
                                    class="bi bi-filetype-pdf"></i></button> <button onclick="exportReportToExcel()"
                                class="btn btn-success">Export
                                Excel <i class="bi bi-file-earmark-spreadsheet"></i></button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-md" id="sortTable" cellspacing="0"
                                width="100%">
                                <thead class="thead-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">OrderId</th>
                                        <th scope="col">Quantity</th>
                                        <th scope="col">Payment</th>
                                        <th scope="col">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <%if(orderDataDownload && orderDataDownload.length>0) {%>

                                        <% orderDataDownload.forEach((order)=>{ %>
                                            <tr>
                                                <th scope="row">
                                                    <%=orderDataDownload.indexOf(order)+1 %>
                                                </th>
                                                <% const dd=order.date.getDate(); const mm=order.date.getMonth() + 1;
                                                    const yyyy=order.date.getFullYear(); const
                                                    formattedDate=`${dd}-${mm}-${yyyy}`; %>
                                                    <td>
                                                        <%=formattedDate %>
                                                    </td>
                                                    <td>
                                                        <%=order.deliveryAddress.name %>
                                                    </td>
                                                    <td>
                                                        <%=order._id%>
                                                    </td>

                                                    <td>
                                                        <%=order.products.length %>
                                                    </td>
                                                    <td>
                                                        <%=order.paymentMethod %>
                                                    </td>
                                                    <td>
                                                        <%=order.totalPrice %>
                                                    </td>
                                            </tr>
                                            <% }) %>
                                                <% }else{ %>
                                                    <tr class="text-center">
                                                        <td colspan="7" class="text-center">No data available</td>
                                                    </tr>
                                                    <% } %>

                                </tbody>
                            </table>
                            <div id="salesReportDownloadableTable" hidden>
                                <table class="table text-center w-100" id="downloadTable">
                                    <div class="text-center">
                                        <h1>Sales Report - VOX</h1>

                                    </div>
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Date</th>
                                            <th scope="col">Name</th>
                                            <th scope="col">OrderId</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Payment</th>
                                            <th scope="col">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <%if(orderDataDownload && orderDataDownload.length>0) {%>

                                        <% orderDataDownload.forEach((order)=>{ %>
                                            <tr>
                                                <th scope="row">
                                                    <%=orderDataDownload.indexOf(order)+1 %>
                                                </th>
                                                <% const dd=order.date.getDate(); const mm=order.date.getMonth() + 1;
                                                    const yyyy=order.date.getFullYear(); const
                                                    formattedDate=`${dd}-${mm}-${yyyy}`; %>
                                                    <td>
                                                        <%=formattedDate %>
                                                    </td>
                                                    <td>
                                                        <%=order.deliveryAddress.name %>
                                                    </td>
                                                    <td>
                                                        <%=order._id%>
                                                    </td>

                                                    <td>
                                                        <%=order.products.length %>
                                                    </td>
                                                    <td>
                                                        <%=order.paymentMethod %>
                                                    </td>
                                                    <td>
                                                        <%=order.totalPrice %>
                                                    </td>
                                            </tr>
                                            <% }) %>
                                            <% }else{ %>
                                                <tr class="text-center">
                                                    <td colspan="7" class="text-center">No data available</td>
                                                </tr>
                                                <% } %>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

    </body>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
    </script>

    <script>

        var salesPerMonthElements = document.getElementById('salesData').innerHTML;
        var salesData = salesPerMonthElements.split(',')

        var salesMonths = document.getElementById('monthData').innerHTML;
        var monthData = salesMonths.split(',');

        const displayValue = document.getElementById('displayValue').innerHTML;


        let yearOfSale = document.getElementById('salesYear').textContent
        let xDisplayValue = document.getElementById('xDisplayValue').textContent

        var options = {
            series: [{
                name: "Sales",
                data: salesData

            }],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight'
            },
            title: {
                text: `Sales of  ${displayValue}`,
                align: 'left'
            },
            grid: {
                row: {
                    colors: ['#f3f3f3', 'transparent'], // takes an array which will be repeated on columns
                    opacity: 0.5
                },
            },
            xaxis: {
                categories: monthData,
                title: {
                    text: xDisplayValue
                }

            },
            yaxis: {
                title: {
                    text: 'sales'
                }
            }, tooltip: {
                y: {
                    formatter: function (val) {
                        return "₹ " + val
                    }
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    </script>


    <!-- category -->
    <script>
        var categoryNamesData = document.getElementById('allCategories').innerHTML;
        var categoryNames = categoryNamesData.split(',')
        var categorySalesData = document.getElementById('categorySales').innerHTML;
        var categorySales = categorySalesData.split(',')

        function generateRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function pushRandomUniqueColorsToArray(array, numColors) {
            for (let i = 0; i < numColors; i++) {
                let newColor;
                do {
                    newColor = generateRandomColor();
                } while (array.includes(newColor));

                array.push(newColor);
            }
        }

        // Example usage
        const colorsArray = [];
        pushRandomUniqueColorsToArray(colorsArray, categorySales.length);
        var options = {
            series: [{
                name: 'Net Sales',
                data: categorySales
            }],
            chart: {
                type: 'bar',
                height: 350
            },
            plotOptions: {
                bar: {
                    borderRadius: 0,
                    distributed: true,
                    barHeight: '80%',
                },
            },
            colors: colorsArray,
            dataLabels: {
                enabled: false,

            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                categories: categoryNames,
                title: {
                    text: 'Categories'
                }
            },
            yaxis: {
                title: {
                    text: 'Sales'
                }
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return "₹ " + val
                    }
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#catChart"), options);
        chart.render();
    </script>

    <!-- payment -->
    <script>
        var paymentMethodsData = document.getElementById('paymentMethods').innerHTML;
        var paymentMethods = paymentMethodsData.split(',')

        var paymentCountData = document.getElementById('paymentCount').innerHTML;
        var paymentCount = paymentCountData.split(',').map(item => Number(item.trim()));
        paymentCount.map((data) => parseInt(data))
        // console.log(paymentCount);

        var options = {
            series: paymentCount,
            chart: {
                width: 380,
                type: 'pie',
            },
            labels: paymentMethods,
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: 200
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#paymentChart"), options);
        chart.render();
    </script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    //
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"> </script>

    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>

    <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.8/xlsx.full.min.js"></script>

    <script src="/javascript/admin/dashboard.js"></script>








    <%- include('../includes/admin/adminFooter.ejs') %>